<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VS Browser</title>
    <style>
        /* Базовые стили */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #e9eef2;
            color: #333;
        }
        
        /* Хедер браузера */
        .browser-header {
            background: linear-gradient(90deg, #34495e, #5d7890);
            color: white;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Адресная строка */
        .address-bar {
            flex: 1;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s;
        }
        
        /* Кнопки навигации */
        .nav-buttons button,
        .go-button {
            background: none;
            border: none;
            color: white;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 18px; /* Увеличил размер для символов */
            border-radius: 4px;
            transition: background 0.2s, transform 0.1s;
        }
        
        .nav-buttons button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .go-button {
            background: #2ecc71;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            padding: 8px 15px;
        }
        .go-button:hover {
            background: #27ae60;
        }
        
        /* Стили для вкладок */
        .tab-bar {
            background: #e1e8ed;
            display: flex;
            height: 35px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .tab {
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-right: 1px solid #c8d0d6;
            cursor: pointer;
            background: #f0f3f5;
            color: #34495e;
            font-size: 14px;
            transition: background 0.2s;
            max-width: 200px;
            min-width: 100px;
        }
        
        .tab:hover {
            background: #d4dde4;
        }

        .tab.active {
            background: white;
            border-bottom: 2px solid #34495e;
            position: relative;
            z-index: 1;
        }

        .tab-close {
            margin-left: 10px;
            font-size: 16px;
            color: #a0a0a0;
            cursor: pointer;
            transition: color 0.1s;
        }

        .tab-close:hover {
            color: #333;
        }

        .new-tab-button {
            background: none;
            border: none;
            color: #34495e;
            font-size: 20px;
            padding: 0 10px;
            cursor: pointer;
        }
        .new-tab-button:hover {
            background: #d4dde4;
        }
        
        /* Контейнер для фреймов */
        .frame-container {
            width: 100%;
            height: calc(100vh - 89px); /* 54px (header) + 35px (tab-bar) */
            position: relative;
        }

        .browser-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .browser-frame.active {
            opacity: 1;
            z-index: 0;
        }

        /* Состояние загрузки */
        .loading {
            padding: 40px;
            text-align: center;
            color: #666;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="browser-header">
        <div class="nav-buttons">
            <button onclick="goBack()" title="Назад">◀</button>
            <button onclick="goForward()" title="Вперед">▶</button>
            <button onclick="refresh()" title="Обновить">↻</button>
        </div>
        
        <input type="text" class="address-bar" id="addressBar" 
               placeholder="Введите адрес (например: mail.vs)" 
               onkeypress="handleAddressEnter(event)">
        
        <button class="go-button" onclick="goToAddress()">Перейти</button>
    </div>

    <div class="tab-bar" id="tabBar">
        <button class="new-tab-button" onclick="openNewTab('welcome.vs')" title="Новая вкладка">+</button>
    </div>

    <div class="frame-container" id="frameContainer">
        </div>

    <script src="api.js"></script>
    <script>
        let tabs = []; // Массив для хранения всех данных вкладок
        let activeTabIndex = -1;

        // *** Вспомогательные функции DOM ***

        function getActiveTab() {
            return tabs[activeTabIndex];
        }

        function getActiveFrame() {
            return document.getElementById(`frame-${activeTabIndex}`);
        }

        function getActiveAddressBar() {
            return document.getElementById('addressBar');
        }

        // *** Управление вкладками ***

        function updateTabBar() {
            const tabBar = document.getElementById('tabBar');
            tabBar.innerHTML = ''; // Очищаем панель
            
            // Кнопка "Новая вкладка"
            const newTabButton = document.createElement('button');
            newTabButton.className = 'new-tab-button';
            newTabButton.setAttribute('onclick', "openNewTab('welcome.vs')");
            newTabButton.innerHTML = '+';
            tabBar.appendChild(newTabButton);


            tabs.forEach((tab, index) => {
                const tabElement = document.createElement('div');
                tabElement.className = 'tab' + (index === activeTabIndex ? ' active' : '');
                tabElement.setAttribute('data-index', index);
                tabElement.onclick = () => switchToTab(index);

                const titleSpan = document.createElement('span');
                titleSpan.textContent = tab.title || tab.url; // Показываем заголовок или URL
                tabElement.appendChild(titleSpan);

                const closeSpan = document.createElement('span');
                closeSpan.className = 'tab-close';
                closeSpan.innerHTML = '×';
                closeSpan.onclick = (e) => {
                    e.stopPropagation(); // Останавливаем переключение вкладки при нажатии на закрытие
                    closeTab(index);
                };
                tabElement.appendChild(closeSpan);

                tabBar.appendChild(tabElement);
            });
        }
        
        function switchToTab(index) {
            if (index === activeTabIndex) return;

            // Скрываем текущий фрейм
            if (activeTabIndex !== -1) {
                const oldFrame = document.getElementById(`frame-${activeTabIndex}`);
                if (oldFrame) oldFrame.className = 'browser-frame';
                document.querySelector(`.tab[data-index="${activeTabIndex}"]`).classList.remove('active');
            }

            activeTabIndex = index;

            // Показываем новый фрейм
            const newFrame = document.getElementById(`frame-${activeTabIndex}`);
            newFrame.className = 'browser-frame active';
            document.querySelector(`.tab[data-index="${activeTabIndex}"]`).classList.add('active');

            // Обновляем адресную строку
            getActiveAddressBar().value = tabs[activeTabIndex].url;
        }

        function closeTab(index) {
            const frameContainer = document.getElementById('frameContainer');
            const frameToRemove = document.getElementById(`frame-${index}`);
            
            if (frameToRemove) {
                frameContainer.removeChild(frameToRemove);
            }

            tabs.splice(index, 1);

            if (tabs.length === 0) {
                // Если нет вкладок, открываем новую
                openNewTab('welcome.vs');
            } else if (index === activeTabIndex) {
                // Если закрыли активную вкладку, переключаемся на предыдущую или первую
                const newIndex = Math.min(index, tabs.length - 1);
                activeTabIndex = -1; // Сбрасываем для корректного переключения
                switchToTab(newIndex);
            } else if (index < activeTabIndex) {
                // Если закрыли вкладку до активной, сдвигаем активный индекс
                activeTabIndex--;
            }
            
            updateTabBar();
        }

        function openNewTab(url) {
            const newIndex = tabs.length;
            
            // Создаем новый элемент фрейма
            const newFrame = document.createElement('iframe');
            newFrame.className = 'browser-frame';
            newFrame.id = `frame-${newIndex}`;
            newFrame.setAttribute('sandbox', 'allow-scripts allow-forms allow-same-origin');
            document.getElementById('frameContainer').appendChild(newFrame);

            // Создаем объект вкладки
            tabs.push({
                url: '',
                title: 'Новая вкладка',
                history: [],
                historyIndex: -1
            });

            // Переключаемся на новую вкладку
            switchToTab(newIndex);
            
            updateTabBar();
            navigateTo(url);
        }

        // *** Управление навигацией ***

        function handleAddressEnter(event) {
            if (event.key === 'Enter') {
                goToAddress();
            }
        }
        
        function goToAddress() {
            const address = getActiveAddressBar().value.trim();
            if (address) {
                navigateTo(address);
            }
        }
        
        // Эта функция должна быть глобальной для вызова из iframe
        window.navigateTo = async function(url) {
            const frame = getActiveFrame();
            const currentTab = getActiveTab();
            
            if (!frame || !currentTab) return; // Проверка, что вкладка существует

            const loadingHtml = '<div class="loading">Загрузка...</div>';
            frame.srcdoc = loadingHtml;
            
            try {
                const content = await loadWebsite(url);
                
                // Обновляем историю и URL
                currentTab.history = currentTab.history.slice(0, currentTab.historyIndex + 1);
                currentTab.history.push(url);
                currentTab.historyIndex = currentTab.history.length - 1;
                currentTab.url = url;
                
                getActiveAddressBar().value = url;
                frame.srcdoc = content;

                // Попытка извлечь заголовок из загруженного контента
                const match = content.match(/<title>(.*?)<\/title>/i);
                currentTab.title = match ? match[1].trim() : url;

                updateTabBar();

            } catch (error) {
                currentTab.url = url; // Все равно обновляем URL
                getActiveAddressBar().value = url;
                currentTab.title = 'Ошибка';
                updateTabBar();

                frame.srcdoc = `
                    <div style="padding: 20px; text-align: center; color: #e74c3c;">
                        <h2>❌ Ошибка загрузки</h2>
                        <p>${error.message}</p>
                        <p>Попробуйте другой адрес</p>
                    </div>
                `;
            }
        }
        
        // Функция для загрузки страницы, когда мы идем вперед/назад в истории
        async function loadFromHistory(url) {
            const frame = getActiveFrame();
            const currentTab = getActiveTab();

            if (!frame || !currentTab) return;

            const loadingHtml = '<div class="loading">Загрузка...</div>';
            frame.srcdoc = loadingHtml;

            try {
                const content = await loadWebsite(url);
                currentTab.url = url;
                getActiveAddressBar().value = url;
                
                // Попытка извлечь заголовок
                const match = content.match(/<title>(.*?)<\/title>/i);
                currentTab.title = match ? match[1].trim() : url;
                updateTabBar();

                frame.srcdoc = content;
            } catch (error) {
                 frame.srcdoc = `
                    <div style="padding: 20px; text-align: center; color: #e74c3c;">
                        <h2>❌ Ошибка загрузки</h2>
                        <p>${error.message}</p>
                        <p>Попробуйте другой адрес</p>
                    </div>
                `;
            }
        }

        function goBack() {
            const currentTab = getActiveTab();
            if (currentTab && currentTab.historyIndex > 0) {
                currentTab.historyIndex--;
                const url = currentTab.history[currentTab.historyIndex];
                loadFromHistory(url);
            }
        }
        
        function goForward() {
            const currentTab = getActiveTab();
            if (currentTab && currentTab.historyIndex < currentTab.history.length - 1) {
                currentTab.historyIndex++;
                const url = currentTab.history[currentTab.historyIndex];
                loadFromHistory(url);
            }
        }
        
        function refresh() {
            const currentTab = getActiveTab();
            if (currentTab && currentTab.history[currentTab.historyIndex]) {
                navigateTo(currentTab.history[currentTab.historyIndex]);
            }
        }
        
        // Загружаем стартовую страницу при запуске
        window.onload = function() {
            openNewTab('searchit.vs'); // Теперь это здесь
        };
    </script>
</body>
</html>
